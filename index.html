<!DOCTYPE html>
<html lang="fr">
<head>
  <title>Capturer une Photo et Envoyer à Google Sheets</title>
  <style>
    /* CSS pour styliser la page */
  </style>
</head>
<body>
  <h1>Capturer une Photo</h1>
  <video id="video" autoplay playsinline></video>
  <button id="startbutton">Prendre Photo</button>
  <canvas id="canvas"></canvas>
  <img id="photo" alt="Votre photo apparaîtra ici.">
  <script>
    (async () => {
      let video = document.getElementById('video');
      let canvas = document.getElementById('canvas');
      let photo = document.getElementById('photo');
      let startbutton = document.getElementById('startbutton');
      
      try {
        let stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        video.srcObject = stream;
      } catch (err) {
        alert('Erreur: Impossible d\'accéder à la caméra. Vérifiez les permissions.');
        console.error(err);
      }

      startbutton.addEventListener('click', () => {
        let context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        let data = canvas.toDataURL('image/png');
        photo.setAttribute('src', data);

        if (navigator.onLine) {
          fetch("https://script.google.com/macros/s/AKfycbzoII3KJ4RpyShvGOsYR6T5hiX8XPxOmnbQmPduIpRFoN1ioomhBWCX7sAWUx3AQ_pV/exec", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ imageData: data })
          })
          .then(response => response.json())
          .then(data => {
            alert("Photo enregistrée avec succès.");
            localStorage.removeItem('capturedPhoto');
          })
          .catch(error => {
            console.error("Erreur lors de l'enregistrement de la photo:", error.message);
          });
        } else {
          localStorage.setItem('capturedPhoto', data);
          alert('Photo enregistrée localement. Elle sera envoyée une fois la connexion rétablie.');
        }
      });

      // Tentative d'envoi des photos sauvegardées localement lorsque l'utilisateur se reconnecte à Internet.
      window.addEventListener('online', () => {
        let savedPhoto = localStorage.getItem('capturedPhoto');
        if (savedPhoto) {
          fetch("https://script.google.com/macros/s/AKfycbzoII3KJ4RpyShvGOsYR6T5hiX8XPxOmnbQmPduIpRFoN1ioomhBWCX7sAWUx3AQ_pV/exec", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ imageData: savedPhoto })
          })
          .then(response => response.json())
          .then(data => {
            alert("Photo enregistrée avec succès.");
            localStorage.removeItem('capturedPhoto');
          })
          .catch(error => {
            console.error("Erreur lors de l'enregistrement de la photo:", error.message);
          });
        }
      });

    })();
  </script>
</body>
</html>